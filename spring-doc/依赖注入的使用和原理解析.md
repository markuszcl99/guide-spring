## å‰è¨€

æºç åœ¨æˆ‘githubçš„[guide-spring](https://github.com/markuszcl99/guide-spring)ä»“åº“ä¸­ï¼Œå¯ä»¥å…‹éš†ä¸‹æ¥ ç›´æ¥æ‰§è¡Œã€‚

æˆ‘ä»¬æœ¬æ–‡ä¸»è¦æ¥ä»‹ç»`ä¾èµ–æ³¨å…¥`çš„ä½¿ç”¨ç¤ºä¾‹åŠå…¶åŸç†

## ä¾èµ–æ³¨å…¥

### ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥

ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼Œç®€ç§°DIï¼‰æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå®ƒç”¨äºå®ç°å¯¹è±¡ä¹‹é—´çš„æ¾æ•£è€¦åˆã€‚åœ¨ä¾èµ–æ³¨å…¥ä¸­ï¼Œä¸€ä¸ªå¯¹è±¡ä¸å†è´Ÿè´£åˆ›å»ºæˆ–æŸ¥æ‰¾å®ƒæ‰€ä¾èµ–çš„å¯¹è±¡ï¼Œè€Œæ˜¯å°†è¿™äº›ä¾èµ–å…³ç³»é€šè¿‡å¤–éƒ¨ä¼ é€’è¿›æ¥ï¼Œå¤–éƒ¨æŒ‡çš„å°±æ˜¯ IoC å®¹å™¨ï¼ŒIoC å®¹å™¨è´Ÿè´£å¯¹è±¡çš„åˆ›å»ºã€ç®¡ç†å’Œæ³¨å…¥ï¼Œæˆ‘ä»¬ä¹Ÿå¸¸è¯´ DI æ˜¯å®ç° IoC çš„ä¸€ç§å…·ä½“æŠ€æœ¯ã€‚è¿™ç§æ–¹å¼æœ‰åŠ©äºæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§ï¼ŒåŒæ—¶é™ä½äº†ç»„ä»¶ä¹‹é—´çš„è€¦åˆåº¦ã€‚

### ä¾èµ–æ³¨å…¥çš„æ–¹å¼

æ³¨å…¥çš„æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- setteræ–¹æ³•æ³¨å…¥
- æ„é€ å™¨æ³¨å…¥
- å­—æ®µæ³¨å…¥
- æ–¹æ³•æ³¨å…¥
- æ¥å£å›è°ƒæ³¨å…¥

#### setteræ–¹æ³•å’Œæ„é€ å™¨æ³¨å…¥æ–¹å¼

å…¶ä¸­setteræ–¹æ³•æ³¨å…¥å’Œæ„é€ å™¨æ³¨å…¥åœ¨xmlé…ç½®æ‰‹åŠ¨æ³¨å…¥æ—¶ï¼Œæ¯”è¾ƒå¸¸è§ï¼Œä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š

**xml é…ç½®**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/util
       http://www.springframework.org/schema/util/spring-util.xsd">

    <bean id="user" class="com.markus.spring.ioc.overview.domain.User">
        <!-- å±æ€§æ³¨å…¥ -->
        <property name="id" value="1"/>
        <property name="username" value="markus zhang"/>
    </bean>
    
    <bean id="user-by-constructor" class="com.markus.spring.ioc.overview.domain.User">
        <!-- æ„é€ å™¨æ³¨å…¥ -->
        <constructor-arg index="0" value="2"/>
        <constructor-arg index="1" value="luna"/>
    </bean>
</beans>

```

**Java ä»£ç **

```java
package com.markus.spring.dependency.injection;

import com.markus.spring.ioc.overview.domain.User;
import org.springframework.context.support.ClassPathXmlApplicationContext;

/**
 * @author: markus
 * @date: 2023/12/24 10:57 AM
 * @Description: setteræ–¹æ³•å’Œæ„é€ å™¨æ³¨å…¥ ç¤ºä¾‹
 * @Blog: https://markuszhang.com
 * It's my honor to share what I've learned with you!
 */
public class SetterAndConstructorInjectionDemo {
    public static void main(String[] args) {
        ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext("classpath:/META-INF/dependency-inject.xml");

        User user = context.getBean("user", User.class);
        System.out.println(user);

        User userByConstructor = context.getBean("user-by-constructor", User.class);
        System.out.println(userByConstructor);

        context.close();
    }
}
```

**æ§åˆ¶å°**

![image-20231224105957921](https://img.markuszhang.com/img/image-20231224105957921.png)

#### æ¥å£å›è°ƒæ³¨å…¥

å­—æ®µå’Œæ–¹æ³•æ³¨å…¥çš„æ–¹å¼æˆ‘ä»¬æ”¾åœ¨ä¸‹é¢çš„è‡ªåŠ¨ç»‘å®šæ¥è¯´ã€‚æ¥ä¸‹æ¥å…ˆæŠŠæ¥å£å›è°ƒçš„æ³¨å…¥æ–¹å¼ä»‹ç»ä¸€ä¸‹ã€‚

**å‡†å¤‡ä¸€ä¸ªJava Bean**

æˆ‘ä»¬åœ¨åŸæœ¬ User è¿™ä¸ª Java Bean çš„åŸºç¡€ä¸Šï¼Œè®©å…¶å®ç° BeanNameAware æ¥å£å¹¶é‡å†™å…¶ setBeanName æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ IoC åˆ›å»ºè¯¥ Bean çš„æ—¶å€™å®Œæˆ beanName å±æ€§å€¼çš„å›è°ƒæ³¨å…¥ã€‚

```java
package com.markus.spring.ioc.overview.domain;

import org.springframework.beans.factory.BeanNameAware;

import javax.annotation.PostConstruct;
import javax.annotation.PreDestroy;

/**
 * @Author: zhangchenglong06
 * @Date: 2023/11/27
 * @Description:
 */
public class User implements BeanNameAware {
    private Long id;
    private String username;

    private String beanName;

    public User() {
        System.out.println("å¼€å§‹åˆå§‹åŒ–");
    }

    public User(Long id, String username) {
        this.id = id;
        this.username = username;
    }

    @Override
    public void setBeanName(String name) {
        this.beanName = name;
    }
}

```

**ç¼–å†™ä¸€ä¸ªç¤ºä¾‹ä»£ç **

```java
package com.markus.spring.dependency.injection;

import com.markus.spring.ioc.overview.domain.User;
import org.springframework.context.support.ClassPathXmlApplicationContext;

/**
 * @author: markus
 * @date: 2023/12/24 11:06 AM
 * @Description: æ¥å£å›è°ƒæ³¨å…¥ ç¤ºä¾‹
 * @Blog: https://markuszhang.com
 * It's my honor to share what I've learned with you!
 */
public class InterfaceCallbackInjectionDemo {
    public static void main(String[] args) {
        ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext("classpath:/META-INF/dependency-inject.xml");

        User user = context.getBean("user", User.class);
        System.out.println("User Bean Name is [ " + user.getBeanName() + " ]");

        context.close();
    }
}
```

**æ§åˆ¶å°**

![image-20231224110830000](https://img.markuszhang.com/img/image-20231224110830000.png)

### æ‰‹åŠ¨æ³¨å…¥çš„å¼Šç«¯

å‰é¢æˆ‘ä»¬äº†è§£é€šè¿‡å±æ€§æ³¨å…¥ã€æ„é€ å™¨æ³¨å…¥çš„ä½¿ç”¨æ–¹å¼ï¼Œçœ‹ä¼¼æ¯”è¾ƒç®€å•ã€æ–¹ä¾¿ï¼Œä½†è¯•æƒ³ï¼Œå¦‚æœæœ‰æ³¨å…¥é›†åˆåœºæ™¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡æ‰‹åŠ¨æ³¨å…¥åº”è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿä¸‹é¢æ¥æ©é¥°ä¸€ä¸‹ï¼š

**xmlé…ç½®**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/util
       http://www.springframework.org/schema/util/spring-util.xsd">

    <bean id="user" class="com.markus.spring.ioc.overview.domain.User">
        <!-- å±æ€§æ³¨å…¥ -->
        <property name="id" value="1"/>
        <property name="username" value="markus zhang"/>
    </bean>

    <bean id="user-by-constructor" class="com.markus.spring.ioc.overview.domain.User">
        <!-- æ„é€ å™¨æ³¨å…¥ -->
        <constructor-arg index="0" value="2"/>
        <constructor-arg index="1" value="luna"/>
    </bean>

    <bean id="user-list-holder" class="com.markus.spring.ioc.overview.domain.UserListHolder">
        <property name="users">
            <list>
                <ref bean="user"/>
                <ref bean="user-by-constructor"/>
                <!-- ä¾æ¬¡å¢åŠ  -->
            </list>
        </property>
    </bean>
</beans>

```

**ç¤ºä¾‹ä»£ç **

```java
package com.markus.spring.dependency.injection;

import com.markus.spring.ioc.overview.domain.User;
import com.markus.spring.ioc.overview.domain.UserListHolder;
import org.springframework.context.support.ClassPathXmlApplicationContext;

/**
 * @author: markus
 * @date: 2023/12/24 10:57 AM
 * @Description: setteræ–¹æ³•å’Œæ„é€ å™¨æ³¨å…¥ ç¤ºä¾‹
 * @Blog: https://markuszhang.com
 * It's my honor to share what I've learned with you!
 */
public class SetterAndConstructorInjectionDemo {
    public static void main(String[] args) {
        ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext("classpath:/META-INF/dependency-inject.xml");

        UserListHolder userListHolder = context.getBean("user-list-holder", UserListHolder.class);
        System.out.println(userListHolder);

        context.close();
    }
}

```

**æ§åˆ¶å°**

![image-20231224140538059](https://img.markuszhang.com/img/image-20231224140538059.png)

æˆ‘ä»¬çš„ç›®çš„å°±æ˜¯å°†å®¹å™¨ä¸­çš„æ‰€æœ‰ User ç±»å‹çš„ Bean æ³¨å…¥åˆ° UserListHolder ä¸­ï¼Œè¯•æƒ³å¦‚æœå®¹å™¨ä¸­ä¸æ–­çš„å¢åŠ æ–°çš„ User ç±»å‹çš„ Beanï¼Œé‚£ä¹ˆé€šè¿‡æ‰‹åŠ¨æ³¨å…¥çš„æ–¹å¼åˆ™ä¼šæ¯æ¬¡éƒ½éœ€è¦å»ä¿®æ”¹ UserListHolder è¿™ä¸ª Beanï¼Œè¿™éå¸¸çš„ä¸ä¾¿ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥ä»‹ç»ä¸‹ Spring æ¡†æ¶æä¾›çš„ è‡ªåŠ¨ç»‘å®šï¼ˆAutowiringï¼‰ç‰¹æ€§ã€‚

### è‡ªåŠ¨ç»‘å®š

#### ä½¿ç”¨å’Œä¼˜ç‚¹

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å®˜æ–¹å¯¹äºè‡ªåŠ¨ç»‘å®šçš„è¯´æ˜ï¼š[åŸæ–‡é“¾æ¥](https://docs.spring.io/spring-framework/reference/core/beans/dependencies/factory-autowire.html)

![image-20231224130641241](https://img.markuszhang.com/img/image-20231224130641241.png)

ä¸Šé¢è§£é‡Šäº†è‡ªåŠ¨è£…é…çš„åŠŸèƒ½ä»¥åŠå…¶ä¼˜åŠ¿å’Œè‡ªåŠ¨ç»‘å®šçš„æ–¹å¼ã€‚å¤§è‡´æ„æ€æ˜¯è¯´ï¼šSpring IoC å®¹å™¨å¯ä»¥è‡ªåŠ¨ç»‘å®šåä½œ Bean ä¹‹é—´çš„å…³ç³»ã€‚æˆ‘ä»¬å¯ä»¥è®© Spring é€šè¿‡æŸ¥æ‰¾ ApplicationContext ä¸­çš„å†…å®¹å°†å…¶è‡ªåŠ¨è§£ææ³¨å…¥åˆ°ä½ çš„ Bean ä¸­ã€‚è‡ªåŠ¨è£…é…æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

- è‡ªåŠ¨è£…é…å¯ä»¥æ˜¾è‘—å‡å°‘æ‰‹åŠ¨é…ç½®éœ€è¦çš„å±æ€§æˆ–è€…æ„é€ å™¨çš„å‚æ•°
- è‡ªåŠ¨è£…é…å¯ä»¥éšç€å¯¹è±¡çš„å‘å±•è‡ªåŠ¨æ›´æ–°é…ç½®ï¼Œä¾‹å¦‚å¦‚æœéœ€è¦å‘ç±»ä¸­æ·»åŠ ä¾èµ–é¡¹ï¼Œåˆ™æ— éœ€ä¿®æ”¹é…ç½®å³å¯æ»¡è¶³è¯¥ä¾èµ–é¡¹ã€‚

ä¹Ÿç»™å‡ºäº†åŸºäº XMl é…ç½®å…ƒä¿¡æ¯åœºæ™¯ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨è‡ªåŠ¨ç»‘å®šä»¥åŠè‡ªåŠ¨ç»‘å®šçš„å‡ ç§æ¨¡å¼ï¼š

- **no** : é»˜è®¤çŠ¶æ€ï¼Œæ— è‡ªåŠ¨ç»‘å®š
- **byName** : é€šè¿‡å±æ€§åè¿›è¡Œè‡ªåŠ¨ç»‘å®š
- **byType** : é€šè¿‡ç±»å‹è¿›è¡Œè‡ªåŠ¨ç»‘å®š
- **constructor** : å’Œ byType ç›¸ä¼¼ï¼Œä¸åŒçš„æ˜¯ constructor æ˜¯åº”ç”¨ä¸æ„é€ å™¨å‚æ•°ä¸Š

æˆ‘ä»¬å›åˆ°ä¸Šé¢åœ¨æ‰‹åŠ¨æ³¨å…¥çš„å¼Šç«¯ä¸­æ‰€æåˆ°çš„ä¾‹å­ï¼Œæˆ‘ä»¬é€šè¿‡è‡ªåŠ¨ç»‘å®šç¨åŠ æ”¹é€ å³å¯å®Œæˆå³ä¾¿å®¹å™¨ä¸­å¢åŠ å¤šå°‘æˆ–è€…åˆ é™¤å¤šå°‘ User ç±»å‹çš„ Bean é…ç½®éƒ½ä¸éœ€è¦æ›´æ”¹ UserListHolder çš„é…ç½®å®Œæˆå…¶å†…å®¹çš„è‡ªåŠ¨æ›´æ–°ã€‚

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/util
       http://www.springframework.org/schema/util/spring-util.xsd">

    <bean id="user" class="com.markus.spring.ioc.overview.domain.User">
        <!-- å±æ€§æ³¨å…¥ -->
        <property name="id" value="1"/>
        <property name="username" value="markus zhang"/>
    </bean>

    <bean id="user-by-constructor" class="com.markus.spring.ioc.overview.domain.User">
        <!-- æ„é€ å™¨æ³¨å…¥ -->
        <constructor-arg index="0" value="2"/>
        <constructor-arg index="1" value="luna"/>
    </bean>

    <bean id="user-list-holder" class="com.markus.spring.ioc.overview.domain.UserListHolder"
          autowire="byType"> <!--é€šè¿‡ç±»å‹ è‡ªåŠ¨ç»‘å®š-->
<!--        <property name="users">-->
<!--            <list>-->
<!--                <ref bean="user"/>-->
<!--                <ref bean="user-by-constructor"/>-->
<!--                &lt;!&ndash; ä¾æ¬¡å¢åŠ  &ndash;&gt;-->
<!--            </list>-->
<!--        </property>-->
    </bean>
</beans>

```

å†æ¬¡æ‰§è¡Œä¸‹ä¸Šé¢çš„ç¨‹åºï¼Œä¾ç„¶æ­£å¸¸æ‰§è¡Œã€‚

æˆ‘ä»¬é€šè¿‡è‡ªå®šç»‘å®šå¯ä»¥æ³¨å…¥å¾ˆå¤šç±»å‹ï¼ŒåŒ…æ‹¬æ•°ç»„ã€é›†åˆã€Mapä»¥åŠå¤–éƒ¨åŒ–é…ç½®ï¼Œä¸‹é¢æˆ‘ä»¬ç”¨ @Autowired å’Œ @Value æ³¨è§£å®Œæˆè¿™äº›åŠŸèƒ½ã€‚

```java
package com.markus.spring.dependency.injection;

import com.markus.spring.ioc.overview.domain.User;
import com.markus.spring.ioc.overview.domain.UserHolder;
import org.springframework.beans.factory.ObjectFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.*;

import java.util.Collection;
import java.util.Map;
import java.util.Optional;

/**
 * @Author: zhangchenglong06
 * @Date: 2023/12/18
 * @Description: @Autowired æ³¨è§£æ³¨å…¥ç¤ºä¾‹
 */
@Configuration
@PropertySource("classpath:/META-INF/application.properties")
public class AtAutowiredAnnotationInjectionDemo {

    @Autowired
    private Optional<User> optionalUser;

    @Autowired
    private ObjectFactory<User> userObjectFactory;

    /**
     * @Autowired æ³¨å…¥æµç¨‹
     * 1. å…ˆæŒ‰ç…§åç§°æŸ¥æ‰¾
     * 2. å†æŒ‰ç…§ç±»å‹æŸ¥æ‰¾
     */
    @Autowired
    private User user1;

    @Autowired
    private Collection<User> users;

    @Autowired
    private Map<String, User> userMap;

    @Autowired
    private User[] userArrays;

    private User userFromMethodInjection;

    @Autowired
    public void setUserFromMethodInjection(User user) {
        this.userFromMethodInjection = user;
    }

    @Autowired
    private UserHolder userHolder;

    @Value("${my_site}")
    private String mySite;


    public static void main(String[] args) {
        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();
        context.register(AtAutowiredAnnotationInjectionDemo.class);

        context.refresh();

        AtAutowiredAnnotationInjectionDemo demo = context.getBean(AtAutowiredAnnotationInjectionDemo.class);
        System.out.println("demo.optionalUser : " + demo.optionalUser.get());
        System.out.println("demo.userObjectFactory : " + demo.userObjectFactory.getObject());
        System.out.println("demo.user : " + demo.user1);
        System.out.println("demo.users : " + demo.users);
        System.out.println("demo.userMap : " + demo.userMap);

        System.out.print("demo.userArrays : [ ");
        for (User userArray : demo.userArrays) {
            System.out.print(userArray.getBeanName() + " ");
        }
        System.out.println("]");
        System.out.println("demo.userFromMethodInjection : " + demo.userFromMethodInjection);
        System.out.println("demo.userHolder : " + demo.userHolder);
        System.out.println("demo.mySite : " + demo.mySite);

        context.close();
    }

    @Bean("user1")
    public User user1() {
        User user = new User();
        user.setId(1L);
        user.setUsername("Markus Zhang");
        return user;
    }

    @Bean("user2")
    @Primary
    public User user2() {
        User user = new User();
        user.setId(2L);
        user.setUsername("Luna");
        return user;
    }

    @Bean
    public UserHolder userHolder(@Autowired User user) {
        UserHolder userHolder = new UserHolder();
        userHolder.setUser(user);
        return userHolder;
    }
}

```

æˆ‘ä»¬æ¥çœ‹ä¸‹æ§åˆ¶å°

![image-20231224142821275](https://img.markuszhang.com/img/image-20231224142821275.png)

#### ç¼ºç‚¹

ä¸€é¡¹æŠ€æœ¯çš„è½åœ°ï¼Œæœ‰å®ƒé¡ºåº”æ—¶ä»£çš„è¯‰æ±‚ï¼Œä¹Ÿä¸€å®šä¼šæœ‰å®ƒçš„å±€é™æ€§ï¼Œæˆ‘ä»¬é€šè¿‡å®˜ç½‘æ¥å™è¿°ä¸‹ è‡ªåŠ¨ç»‘å®šï¼ˆAutowiringï¼‰ æœ‰ä»€ä¹ˆé™åˆ¶æˆ–è€…ç¼ºç‚¹ï¼š[åŸæ–‡é“¾æ¥](https://docs.spring.io/spring-framework/reference/core/beans/dependencies/factory-autowire.html)

![image-20231224143958183](https://img.markuszhang.com/img/image-20231224143958183.png)

ä¸Šé¢å¤§æ¦‚æè¿°äº† è‡ªåŠ¨ç»‘å®šçš„ç¼ºç‚¹å’Œå®˜æ–¹ç»™ä½ çš„å»ºè®®ï¼š

- ç¼ºç‚¹
    - æ˜¾ç¤ºæ³¨å…¥æ¯”è‡ªåŠ¨ç»‘å®šä¼˜å…ˆçº§æ›´é«˜ï¼Œå®ƒæ€»ä¼šè¦†ç›–è‡ªåŠ¨ç»‘å®šçš„å±æ€§
    - ä¸èƒ½æ³¨å…¥ç®€å•å±æ€§ï¼Œä¾‹å¦‚åŸè¯­ç±»å‹ Stringã€intç­‰ï¼Œè¿™æ˜¯æ¡†æ¶è®¾è®¡çš„é™åˆ¶(ps: ä¸è¿‡è¿™äº›ç±»å‹æˆ‘ä»¬å¯ä»¥é€šè¿‡ @Value å®ç°ï¼Œå‰é¢ç»™å‡ºäº†ä¾‹å­)
    - è‡ªåŠ¨ç»‘å®šæ²¡æœ‰æ˜¾ç¤ºç»‘å®šç²¾ç¡®ï¼Œå°½ç®¡ Spring å·²ç»å¾ˆå°å¿ƒåœ°å¤„ç†ä»¥é¿å…æ­§ä¹‰ï¼Œä½†è¿˜æ˜¯ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„ç»“æœ
    - ç»‘å®šä¿¡æ¯ä¸ä¼šä»¥å¯è§†åŒ–çš„å½¢å¼å±•ç¤ºå‡ºæ¥
    - å¤šä¸ª BeanDefinition çš„æƒ…å†µä¸‹ï¼Œåœ¨æ³¨å…¥ é›†åˆã€æ•°ç»„ã€Mapç­‰åœºæ™¯æ—¶é—®é¢˜ä¸å¤§ï¼Œä½†æ˜¯åœ¨æ³¨å…¥å•ä¸ª Bean æ—¶ï¼Œå¯èƒ½ä¼šäº§ç”Ÿé—®é¢˜ï¼Œå¦‚æœ Spring åœ¨è¿›è¡Œæ³¨å…¥æ—¶æ‰¾ä¸åˆ°å”¯ä¸€ Bean åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸
- å»ºè®®
    - é¿å…ä½¿ç”¨è‡ªåŠ¨ç»‘å®šï¼Œé‡‡ç”¨æ˜¾ç¤ºç»‘å®š
    - å¦‚æœæŸä¸ª Bean ä¸æƒ³è¢«æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­ï¼Œåˆ™å¯é€šè¿‡ autowired-candidate å±æ€§è®¾ç½®ä¸º false æ¥è·³è¿‡æ³¨å…¥
    - åœ¨æ³¨å…¥å•ä¸ª Bean çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç›®æ ‡ Bean çš„ primary å±æ€§è®¾ç½®ä¸º true
    - é€šè¿‡æ³¨è§£é©±åŠ¨å®ç°æ›´ç²¾ç»†ç²’åº¦çš„æ§åˆ¶

## ä¾èµ–æ³¨å…¥åŸç†

### Bean ç”Ÿå‘½å‘¨æœŸ

åœ¨è¯´ä¾èµ–æ³¨å…¥å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æ•´ä½“çœ‹ä¸‹ Spring Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œç„¶åå†æ¥è¯´ä¾èµ–æ³¨å…¥å‘ç”Ÿåœ¨å“ªä¸ªé˜¶æ®µï¼Œæ¥ç€å†å»å¯¹åº”æºç å¤„è§£æå…¶åŸç†

![Beanç”Ÿå‘½å‘¨æœŸ-doGetBean](https://img.markuszhang.com/img/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-doGetBean.png)

ä¸Šå›¾æ˜¯ Bean æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå›¾ï¼Œæˆ‘ä»¬æ”¾å¤§æ¥çœ‹æ„é€ å™¨æ³¨å…¥å’Œ setter æ–¹æ³•æ³¨å…¥æ‰€åœ¨çš„ç¯èŠ‚:

![image-20231224150625305](https://img.markuszhang.com/img/image-20231224150625305.png)

### æ„é€ å™¨æ³¨å…¥

æˆ‘ä»¬æŠŠ Spring æºç æ‹·è´å‡ºæ¥:

```java
// org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBeanInstance
protected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) {
  // ... å…¶ä»–æµç¨‹çœç•¥
  // Candidate constructors for autowiring?
  Constructor<?>[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);
  if (ctors != null || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||
      mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) {
    return autowireConstructor(beanName, mbd, ctors, args);
  }

  // No special handling: simply use no-arg constructor.
  return instantiateBean(beanName, mbd);
}
```

å¯ä»¥çœ‹åˆ° Spring åœ¨åˆ¤æ–­æ˜¯å¦è¿›è¡Œ æ„é€ å™¨æ³¨å…¥ çš„æ¡ä»¶æœ‰ä»¥ä¸‹å‡ ç§ï¼ˆæ»¡è¶³å…¶ä¸€å³å¯ï¼‰:

- æ„é€ å™¨åˆ—è¡¨ä¸ä¸ºç©º
- BeanDefinition çš„ autowireMode è®¾ç½®ä¸º AUTOWIRE_CONSTRUCTOR
- BeanDefinition æŒ‡å®šäº†æ„é€ å™¨å‚æ•°
- args å‚æ•°ä¸ä¸ºç©ºï¼ˆps: è¿™ä¸ªé€šå¸¸ä¸ºç©ºï¼‰

å¦åˆ™ä¸è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œç›´æ¥ä½¿ç”¨æ— å‚æ„é€ å™¨è¿›è¡Œå®ä¾‹åŒ–ï¼ˆé€šè¿‡ cglib æˆ–è€… jdk åŠ¨æ€ä»£ç†ï¼‰ï¼Œè¿™å—ä¸è¿›è¡Œç»†èŠ‚ä»‹ç»äº†ã€‚

ä¸‹é¢æˆ‘ä»¬è¿›å…¥åˆ° `autowireConstructor` æ–¹æ³•ï¼Œçœ‹çœ‹é‡Œé¢åšäº†ä»€ä¹ˆ:

```java
public BeanWrapper autowireConstructor(String beanName, RootBeanDefinition mbd,
			@Nullable Constructor<?>[] chosenCtors, @Nullable Object[] explicitArgs) {

		BeanWrapperImpl bw = new BeanWrapperImpl();
		this.beanFactory.initBeanWrapper(bw);

		Constructor<?> constructorToUse = null;
		ArgumentsHolder argsHolderToUse = null;
		Object[] argsToUse = null;

		if (explicitArgs != null) {
			argsToUse = explicitArgs;
		}
		else {
			// ... å…¶ä»–ç»†èŠ‚å¿½ç•¥

			// éœ€è¦å»è§£ææ„é€ å™¨
			boolean autowiring = (chosenCtors != null ||
					mbd.getResolvedAutowireMode() == AutowireCapableBeanFactory.AUTOWIRE_CONSTRUCTOR);
			ConstructorArgumentValues resolvedValues = null;

			int minNrOfArgs;
			if (explicitArgs != null) {
				minNrOfArgs = explicitArgs.length;
			}
			else {
				ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues();
				resolvedValues = new ConstructorArgumentValues();
				minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues);
			}

      // ä»¥å‚æ•°ä¸ªæ•°çš„å¤šå°‘å¯¹æ„é€ å™¨è¿›è¡Œæ’åºï¼ˆé¡ºåºä»å¤šåˆ°å°‘ï¼‰
			AutowireUtils.sortConstructors(candidates);
			int minTypeDiffWeight = Integer.MAX_VALUE;
			Set<Constructor<?>> ambiguousConstructors = null;
			LinkedList<UnsatisfiedDependencyException> causes = null;

      // éå† æ„é€ å™¨ï¼Œæ‰¾åˆ°æœ€åˆé€‚çš„æ„é€ å™¨è¿›è¡Œå®ä¾‹åŒ–
			for (Constructor<?> candidate : candidates) {

				int parameterCount = candidate.getParameterCount();

				if (constructorToUse != null && argsToUse != null && argsToUse.length > parameterCount) {
					// æ‰¾åˆ°äº†æœ€é€‚åˆçš„æ„é€ å™¨ï¼Œåé¢ä¸éœ€è¦å†æ‰¾äº†
					break;
				}
				if (parameterCount < minNrOfArgs) {
					continue;
				}

				ArgumentsHolder argsHolder;
				Class<?>[] paramTypes = candidate.getParameterTypes();
				if (resolvedValues != null) {
          // ...  çœç•¥ç»†èŠ‚
          // æ ¸å¿ƒæ–¹æ³•ï¼Œæ˜¯è§£æå½“å‰å€™é€‰æ„é€ å™¨å‚æ•°å¯¹åº”çš„å‚æ•°å€¼
          argsHolder = createArgumentArray(beanName, mbd, resolvedValues, bw, paramTypes, paramNames,
              getUserDeclaredConstructor(candidate), autowiring, candidates.length == 1);
          
          // ... çœç•¥ç»†èŠ‚
				}
        // ... çœç•¥

				int typeDiffWeight = (mbd.isLenientConstructorResolution() ?
						argsHolder.getTypeDifferenceWeight(paramTypes) : argsHolder.getAssignabilityWeight(paramTypes));
        // å¦‚æœè¿™ä¸ªæ„é€ å™¨æœ€è¿‘æ¥åŒ¹é…çš„è¯ï¼Œå°±é€‰æ‹©è¿™ä¸ªæ„é€ å™¨è¿›è¡Œå®ä¾‹åŒ–
				// Choose this constructor if it represents the closest match.
				if (typeDiffWeight < minTypeDiffWeight) {
					constructorToUse = candidate;
					argsHolderToUse = argsHolder;
					argsToUse = argsHolder.arguments;
					minTypeDiffWeight = typeDiffWeight;
					ambiguousConstructors = null;
				}
				// ... 
			}

			// ... çœç•¥å…¶ä»–ç»†èŠ‚
		}
		bw.setBeanInstance(instantiate(beanName, mbd, constructorToUse, argsToUse));
		return bw;
	}
```

æ€»ç»“ä¸€ä¸‹ï¼š

- è·å–å€™é€‰æ„é€ å™¨é›†åˆ
- å¯¹æ„é€ å™¨é›†åˆè¿›è¡Œæ’åºï¼ˆæ ¹æ®å‚æ•°æ•°é‡ä»å¤šåˆ°å°‘è¿›è¡Œæ’åºï¼‰
- éå†æ„é€ å™¨é›†åˆï¼Œä¾æ¬¡è§£ææ„é€ å™¨çš„å‚æ•°å¯¹åº”çš„å€¼ï¼ˆæ ¸å¿ƒæ–¹æ³• createArgumentArrayï¼‰
- è§£æå‡ºå€¼ä»¥åï¼Œé€šè¿‡åå°„è®¡ç®—å‡ºç±»å‹å·®å¼‚æƒé‡ï¼ˆSpring è®¾è®¡å‡ºæ¥çš„ä¸€ä¸ªç®—æ³•ï¼Œæœ‰å…´è¶£çš„å¯ä»¥äº†è§£ä¸‹ org.springframework.util.MethodInvoker#getTypeDifferenceWeightï¼‰
- å¦‚æœå·®å¼‚ç»“æœæœ€åŒ¹é…ï¼Œå°±é€‰æ‹©è¿™ä¸ªæ„é€ å™¨è¿›è¡Œå®ä¾‹åŒ–

æˆ‘ä»¬å†æ·±å…¥åˆ°`createArgumentArray`æ–¹æ³•ä¸­å»çœ‹ä¸‹

```java
private ArgumentsHolder createArgumentArray(
			String beanName, RootBeanDefinition mbd, @Nullable ConstructorArgumentValues resolvedValues,
			BeanWrapper bw, Class<?>[] paramTypes, @Nullable String[] paramNames, Executable executable,
			boolean autowiring, boolean fallback) throws UnsatisfiedDependencyException {
  	// ... çœç•¥ç»†èŠ‚

		for (int paramIndex = 0; paramIndex < paramTypes.length; paramIndex++) {
			if (valueHolder != null) {
		  	// ... çœç•¥ç»†èŠ‚
			}
			else {
      	// ... çœç•¥ç»†èŠ‚
				try {
          // æ ¸å¿ƒåœ¨è¿™ï¼Œä¾æ¬¡è§£ææ„é€ å™¨ä¸­çš„å‚æ•°å€¼
					Object autowiredArgument = resolveAutowiredArgument(
							methodParam, beanName, autowiredBeanNames, converter, fallback);
					args.rawArguments[paramIndex] = autowiredArgument;
					args.arguments[paramIndex] = autowiredArgument;
					args.preparedArguments[paramIndex] = autowiredArgumentMarker;
					args.resolveNecessary = true;
				}
				catch (BeansException ex) {
					throw new UnsatisfiedDependencyException(
							mbd.getResourceDescription(), beanName, new InjectionPoint(methodParam), ex);
				}
			}
    	// ... çœç•¥ç»†èŠ‚
		}

  	// ... çœç•¥ç»†èŠ‚
		return args;
	}

```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`createArgumentArray`æ–¹æ³•ä¸­ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯éå†æ„é€ å™¨çš„å‚æ•°ï¼Œä¾æ¬¡è§£æå…¶å‚æ•°å€¼ï¼Œæˆ‘ä»¬å†å¾€ä¸‹çœ‹ä¸€ä¸‹`resolveAutowiredArgument`æ–¹æ³•ï¼Œçœ‹ä¸‹å®ƒæ˜¯å¦‚ä½•è§£æå‡ºå…·ä½“å€¼çš„ã€‚

```java
protected Object resolveAutowiredArgument(MethodParameter param, String beanName,
			@Nullable Set<String> autowiredBeanNames, TypeConverter typeConverter, boolean fallback) {

		// ... çœç•¥ç»†èŠ‚
		try {
      // è¿™å—å°±æ˜¯æœ€æœ€æœ€æœ€æœ€æœ€æœ€æ ¸å¿ƒçš„å‡½æ•°äº†ï¼Œæˆ‘ä»¬åœ¨æ­å¹•åˆ°è¿™
			return this.beanFactory.resolveDependency(
					new DependencyDescriptor(param, true), beanName, autowiredBeanNames, typeConverter);
		}
		// ... çœç•¥ç»†èŠ‚
	}
```

å¯ä»¥çœ‹åˆ° ä¾èµ–æ³¨å…¥å®ç°åŸç†ä¸­æœ€æœ€æœ€æœ€æ ¸å¿ƒçš„å‡½æ•° org.springframework.beans.factory.config.AutowireCapableBeanFactory#resolveDependency(xxx) éœ²å‡ºæ°´é¢äº†ğŸ˜„ï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆä¸æ·±å…¥è§£æï¼Œç‚¹åˆ°ä¸ºæ­¢ã€‚



æ€»ç»“ä¸€ä¸‹ï¼šæ„é€ å™¨æ³¨å…¥å‘ç”Ÿåœ¨ Bean ç”Ÿå‘½å‘¨æœŸä¸­ `å®ä¾‹åŒ– Bean é˜¶æ®µ`ï¼Œä¹Ÿå°±æ˜¯ createBeanInstance å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦ç›®çš„å°±æ˜¯é€‰æ‹©å‡º Bean å¯¹è±¡ä¸­æœ€åˆé€‚çš„æ„é€ å™¨å®Œæˆå¯¹ Bean çš„å®ä¾‹åŒ–ï¼Œåœ¨é€‰æ‹©æ„é€ å™¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ä¸€æ­¥åˆ¤æ–­ ç”¨æˆ·æ˜¯å¦é€‰æ‹©è¿›è¡Œæ„é€ å™¨è‡ªåŠ¨ç»‘å®šçš„é€»è¾‘ï¼Œå¦‚æœç”¨æˆ·é€‰æ‹©äº†æ„é€ å™¨è‡ªåŠ¨ç»‘å®šï¼Œé‚£ä¹ˆ Spring æ¡†æ¶ä¼šé€šè¿‡`åå°„`è·å–è¯¥ç±»çš„æ‰€æœ‰æ„é€ å™¨ï¼Œé€‰æ‹©å‡ºæœ€é€‚åˆçš„æ„é€ å™¨è¿›è¡Œå®ä¾‹åŒ–ã€‚è€Œåœ¨é€‰æ‹©æ„é€ å™¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå¯¹æ„é€ å™¨çš„å‚æ•°è¿›è¡Œè§£æï¼Œè§£æå‡ºæ¥ä»¥åï¼Œé€šè¿‡å¯¹æ¯”å·®å¼‚ï¼ˆSpring å®ç°äº†ä¸€å¥—ç±»å‹ä¸å‚æ•°å€¼çš„å·®å¼‚ç®—æ³•ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥æ·±å…¥äº†è§£ä¸‹org.springframework.util.MethodInvoker#getTypeDifferenceWeightï¼‰æ¥å†³å®šæœ€ç»ˆç”¨æ¥å®ä¾‹åŒ–çš„æ„é€ å™¨ã€‚è€Œåœ¨è§£æå‚æ•°å€¼æ—¶ï¼Œæˆ‘ä»¬æ¢ç©¶åˆ° `resolveDependency`è¿™ä¸ªå‡½æ•°ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°å¯ä»¥è§£æå‡ºæ¥å½“å‰å‚æ•°æ‰€å¯¹åº”çš„å€¼ã€‚

æ„é€ å™¨æ³¨å…¥åŸç†å°±å¦‚ä¸Šæ‰€è¿°äº†ã€‚

### setteræ–¹æ³•æ³¨å…¥

åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿå…ˆæŠŠå®ç°setteræ–¹æ³•æ³¨å…¥çš„å…¥å£å‡½æ•°å…ˆæ‹·è´å‡ºæ¥

```java
// org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#populateBean
protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) {
  // ... çœç•¥ç»†èŠ‚

  PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null);

  int resolvedAutowireMode = mbd.getResolvedAutowireMode();
  if (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) {
    MutablePropertyValues newPvs = new MutablePropertyValues(pvs);
    // Add property values based on autowire by name if applicable.
    if (resolvedAutowireMode == AUTOWIRE_BY_NAME) {
      autowireByName(beanName, mbd, bw, newPvs);
    }
    // Add property values based on autowire by type if applicable.
    if (resolvedAutowireMode == AUTOWIRE_BY_TYPE) {
      autowireByType(beanName, mbd, bw, newPvs);
    }
    pvs = newPvs;
  }
  // ... çœç•¥ç»†èŠ‚
}
```

æˆ‘ä»¬çœç•¥å…¶ä»–çš„ç»†èŠ‚ï¼Œé‡ç‚¹çœ‹ä¸‹è¿™ä¸ªå‡½æ•°é‡Œé¢å¯¹äºè‡ªåŠ¨ç»‘å®šçš„å¤„ç†ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ¡†æ¶é€šè¿‡åˆ¤æ–­ BeanDefinition çš„ autowiredMode å±æ€§æ¥å†³å®šæ‰§è¡Œ autowireByName è¿˜æ˜¯ autowireByType å‡½æ•°ã€‚

**autowiredByName**

```java
protected void autowireByName(
    String beanName, AbstractBeanDefinition mbd, BeanWrapper bw, MutablePropertyValues pvs) {

  String[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw);
  // è·å–å±æ€§å
  for (String propertyName : propertyNames) {
    if (containsBean(propertyName)) {
      // é€šè¿‡å±æ€§åç§°è¿›è¡Œä¾èµ–æŸ¥æ‰¾
      Object bean = getBean(propertyName);
      pvs.add(propertyName, bean);
      registerDependentBean(propertyName, beanName);
      if (logger.isTraceEnabled()) {
        logger.trace("Added autowiring by name from bean name '" + beanName +
            "' via property '" + propertyName + "' to bean named '" + propertyName + "'");
      }
    }
    else {
      if (logger.isTraceEnabled()) {
        logger.trace("Not autowiring property '" + propertyName + "' of bean '" + beanName +
            "' by name: no matching bean found");
      }
    }
  }
}
```

**autowiredByType**

```java
protected void autowireByType(
    String beanName, AbstractBeanDefinition mbd, BeanWrapper bw, MutablePropertyValues pvs) {

  TypeConverter converter = getCustomTypeConverter();
  if (converter == null) {
    converter = bw;
  }

  Set<String> autowiredBeanNames = new LinkedHashSet<>(4);
  String[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw);
  for (String propertyName : propertyNames) {
    try {
      PropertyDescriptor pd = bw.getPropertyDescriptor(propertyName);
      // Don't try autowiring by type for type Object: never makes sense,
      // even if it technically is a unsatisfied, non-simple property.
      if (Object.class != pd.getPropertyType()) {
        MethodParameter methodParam = BeanUtils.getWriteMethodParameter(pd);
        // Do not allow eager init for type matching in case of a prioritized post-processor.
        boolean eager = !(bw.getWrappedInstance() instanceof PriorityOrdered);
        DependencyDescriptor desc = new AutowireByTypeDependencyDescriptor(methodParam, eager);
        // è§£æä¾èµ–å€¼
        Object autowiredArgument = resolveDependency(desc, beanName, autowiredBeanNames, converter);
        if (autowiredArgument != null) {
          pvs.add(propertyName, autowiredArgument);
        }
        for (String autowiredBeanName : autowiredBeanNames) {
          registerDependentBean(autowiredBeanName, beanName);
          if (logger.isTraceEnabled()) {
            logger.trace("Autowiring by type from bean name '" + beanName + "' via property '" +
                propertyName + "' to bean named '" + autowiredBeanName + "'");
          }
        }
        autowiredBeanNames.clear();
      }
    }
    catch (BeansException ex) {
      throw new UnsatisfiedDependencyException(mbd.getResourceDescription(), beanName, propertyName, ex);
    }
  }
}
```

é€šè¿‡ç±»å‹æ³¨å…¥ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†è¿™ä¸ªæ ¸å¿ƒå‡½æ•°`resolveDependency`ï¼Œé€šè¿‡å…¶å°†å±æ€§å‚æ•°å€¼è§£æå‡ºæ¥å¹¶å®Œæˆæ³¨å…¥ã€‚

æ€»ç»“ä¸€ä¸‹ï¼šsetteræ–¹æ³•æ³¨å…¥æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€æ˜¯é€šè¿‡åç§°æ³¨å…¥ï¼›äºŒæ˜¯é€šè¿‡ç±»å‹æ³¨å…¥ã€‚åœ¨é€šè¿‡åç§°æ³¨å…¥çš„æ–¹å¼ä¸­ï¼Œæ¡†æ¶é‡‡ç”¨ä¾èµ–æŸ¥æ‰¾å®Œæˆï¼›åœ¨é€šè¿‡ç±»å‹æ³¨å…¥çš„æ–¹å¼ä¸­ï¼Œæ¡†æ¶é‡‡ç”¨è§£æä¾èµ–å®Œæˆã€‚

## ä¾èµ–æ¥æº

å‰é¢æˆ‘ä»¬è§£é‡Šäº†`æ„é€ å™¨æ³¨å…¥`å’Œ`setteræ–¹æ³•æ³¨å…¥`ä¸¤ç§æ–¹å¼çš„åŸç†ï¼Œè¿½æº¯åˆ°åº•å±‚æˆ‘ä»¬å‘ç°ï¼Œä¸¤è€…éƒ½ä¼šé€šè¿‡org.springframework.beans.factory.config.AutowireCapableBeanFactory#resolveDependency(xxx)è¿™ä¸ªå‡½æ•°è·å–è§£æåçš„å‚æ•°å€¼ï¼ˆsetteræ–¹æ³•é€šè¿‡åç§°æ³¨å…¥çš„æ—¶å€™ï¼Œé‡‡ç”¨çš„ä¾èµ–æŸ¥æ‰¾é™¤å¤–ï¼‰ã€‚

è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªç»“è®ºï¼šä¾èµ–æ³¨å…¥çš„æ¥æºä¸»è¦æ¥æºäº getBean(xxx) å’Œ resolveDependency(xxx) ä¸¤å¤„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†æ·±å…¥æ¢ç©¶è¿™ä¸¤ä¸ªæ¥æºã€‚

### getBean(xxx)çš„æ¥æº

getBeanå°±æ˜¯ä¾èµ–æŸ¥æ‰¾ï¼Œè¿½æº¯getBean(xxx)çš„æ¥æºç­‰ä»·äºè¿½æº¯ä¾èµ–æŸ¥æ‰¾çš„æ¥æºã€‚

ä¾èµ–æŸ¥æ‰¾çš„æ¥æºåŒ…æ‹¬ï¼š

- BeanDefinition
    - ç”¨æˆ·é…ç½®
    - Spring å†…å»º
- å•ä¾‹å¯¹è±¡
    - ç”¨æˆ·ä½¿ç”¨ API æ³¨å†Œ
    - Spring å†…å»º

ç”¨æˆ·é…ç½®çš„ BeanDefinition å…ƒä¿¡æ¯æˆ‘ä»¬å°±ä¸ä»‹ç»äº†ï¼Œå¯¹äº Spring å†…å»º BeanDefinition çš„æ³¨å†Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

> org.springframework.context.annotation.AnnotationConfigUtils#registerAnnotationConfigProcessors(org.springframework.beans.factory.support.BeanDefinitionRegistry, java.lang.Object)

![image-20231224190557360](https://img.markuszhang.com/img/image-20231224190557360.png)

æˆ‘ä»¬å†æ¥çœ‹ä¸‹ Spring å†…å»ºå•ä¾‹å¯¹è±¡

> org.springframework.context.support.AbstractApplicationContext#prepareBeanFactory

![image-20231224190909487](https://img.markuszhang.com/img/image-20231224190909487.png)

> org.springframework.context.support.AbstractApplicationContext#initMessageSource
>
> org.springframework.context.support.AbstractApplicationContext#initApplicationEventMulticaster
>
> org.springframework.context.support.AbstractApplicationContext#initLifecycleProcessor

![image-20231224191117105](https://img.markuszhang.com/img/image-20231224191117105.png)

æœ€ç»ˆï¼Œä¾èµ–æŸ¥æ‰¾çš„æ¥æºè¿™ä¸¤é¡¹ï¼š

- org.springframework.beans.factory.support.BeanDefinitionRegistry#registerBeanDefinition
- org.springframework.beans.factory.config.SingletonBeanRegistry#registerSingleton

### resolveDependency(xxx)çš„æ¥æº

é’ˆå¯¹ resolveDependency ä¾èµ–æ¥æºï¼Œæˆ‘ä»¬ç›´æ¥ä»è¿™ä¸ªå…¥å£å¼€å§‹

```java
// org.springframework.beans.factory.support.DefaultListableBeanFactory#doResolveDependency
public Object doResolveDependency(DependencyDescriptor descriptor, @Nullable String beanName,
			@Nullable Set<String> autowiredBeanNames, @Nullable TypeConverter typeConverter) throws BeansException {

  InjectionPoint previousInjectionPoint = ConstructorResolver.setCurrentInjectionPoint(descriptor);
  try {
    // é’ˆå¯¹ @Value æ³¨è§£çš„ä½¿ç”¨åœºæ™¯ï¼Œä¾‹å¦‚ @Value("${xxx:defaultValue}")
    Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor);
    if (value != null) {
      if (value instanceof String) {
        String strVal = resolveEmbeddedValue((String) value);
        BeanDefinition bd = (beanName != null && containsBean(beanName) ?
            getMergedBeanDefinition(beanName) : null);
        value = evaluateBeanDefinitionString(strVal, bd);
      }
      TypeConverter converter = (typeConverter != null ? typeConverter : getTypeConverter());
      try {
        return converter.convertIfNecessary(value, type, descriptor.getTypeDescriptor());
      }
      catch (UnsupportedOperationException ex) {
        // A custom TypeConverter which does not support TypeDescriptor resolution...
        return (descriptor.getField() != null ?
            converter.convertIfNecessary(value, type, descriptor.getField()) :
            converter.convertIfNecessary(value, type, descriptor.getMethodParameter()));
      }
    }

    // è§£æ å­—æ®µç±»å‹ä¸º Arrayã€Collectionã€Mapç­‰çš„åœºæ™¯
    Object multipleBeans = resolveMultipleBeans(descriptor, beanName, autowiredBeanNames, typeConverter);
    if (multipleBeans != null) {
      return multipleBeans;
    }

    // æŒ‰ç…§ç±»å‹ä» æ•°æ®æºä¸­è¿›è¡Œ æŸ¥æ‰¾
    Map<String, Object> matchingBeans = findAutowireCandidates(beanName, type, descriptor);
    if (matchingBeans.isEmpty()) {
      if (isRequired(descriptor)) {
        raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);
      }
      return null;
    }

    String autowiredBeanName;
    Object instanceCandidate;

    // å½“æœ‰å¤šä¸ª åŒ¹é…åˆ°çš„ Bean æƒ…å†µï¼Œå†³å®šé€‰æ‹©å“ªä¸ªä½œä¸ºé¦–é€‰çš„ Bean è¿›è¡Œæ³¨å…¥
    if (matchingBeans.size() > 1) {
      autowiredBeanName = determineAutowireCandidate(matchingBeans, descriptor);
      if (autowiredBeanName == null) {
        if (isRequired(descriptor) || !indicatesMultipleBeans(type)) {
          return descriptor.resolveNotUnique(descriptor.getResolvableType(), matchingBeans);
        }
        else {
          // In case of an optional Collection/Map, silently ignore a non-unique case:
          // possibly it was meant to be an empty collection of multiple regular beans
          // (before 4.3 in particular when we didn't even look for collection beans).
          return null;
        }
      }
      instanceCandidate = matchingBeans.get(autowiredBeanName);
    }
    else {
      // We have exactly one match.
      Map.Entry<String, Object> entry = matchingBeans.entrySet().iterator().next();
      autowiredBeanName = entry.getKey();
      instanceCandidate = entry.getValue();
    }

    if (autowiredBeanNames != null) {
      autowiredBeanNames.add(autowiredBeanName);
    }
    if (instanceCandidate instanceof Class) {
      instanceCandidate = descriptor.resolveCandidate(autowiredBeanName, type, this);
    }
    Object result = instanceCandidate;
    if (result instanceof NullBean) {
      if (isRequired(descriptor)) {
        raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);
      }
      result = null;
    }
    if (!ClassUtils.isAssignableValue(type, result)) {
      throw new BeanNotOfRequiredTypeException(autowiredBeanName, type, instanceCandidate.getClass());
    }
    return result;
  }
  finally {
    ConstructorResolver.setCurrentInjectionPoint(previousInjectionPoint);
  }
}
```

æ€»ç»“ä¸€ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦åšäº†ä¸€ä¸‹äº‹æƒ…ï¼š

- è§£æå­—æ®µè¢« @Value æ ‡æ³¨æ—¶ï¼Œåšä¸€ä¸ªè§£æå¹¶è¿”å›ï¼ˆè§£æçš„è¿‡ç¨‹æ˜¯ï¼Œå¦‚æœæœ‰æ˜¾ç¤ºçš„å±æ€§é…ç½®ï¼Œåˆ™é‡‡ç”¨é…ç½®å€¼ï¼Œæ²¡æœ‰é…ç½®åˆ™é‡‡ç”¨é»˜è®¤å€¼ï¼‰
- è§£æå­—æ®µä¸ºæ•°ç»„ã€é›†åˆæˆ–è€…Mapçš„åœºæ™¯ï¼Œä»`æ•°æ®æº`ä¸­æŒ‰ç…§ç±»å‹æŸ¥æ‰¾å‡ºæ¥å¹¶è®¾ç½®åˆ°å½“å‰å­—æ®µä¸­å»
- è§£æå­—æ®µéä¸Šè¿°æƒ…å†µæ—¶ï¼Œä»`æ•°æ®æº`ä¸­åŒæ ·æŒ‰ç…§ç±»å‹æŸ¥æ‰¾å‡ºæ¥ï¼Œå¹¶é€‰æ‹©å‡ºé¦–é€‰çš„**ä¾èµ–**è¿”å›ã€‚

ä¸Šé¢è¯´çš„`æ•°æ®æº`æ¯”è¾ƒç¥ç§˜ï¼Œæˆ‘ä»¬å°±æ·±å…¥åˆ° determineAutowireCandidate æ–¹æ³•æ¥ä¸€æ¢ç©¶ç«Ÿï¼Œè§£å¼€å…¶ç¥ç§˜çš„é¢çº±

```java
protected Map<String, Object> findAutowireCandidates(
			@Nullable String beanName, Class<?> requiredType, DependencyDescriptor descriptor) {
  // æŒ‰ç…§ç±»å‹ä»å®¹å™¨ä¸­æŸ¥æ‰¾ç›¸å…³çš„å€™é€‰ Bean åç§°
  String[] candidateNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(
      this, requiredType, true, descriptor.isEager());
  Map<String, Object> result = new LinkedHashMap<>(candidateNames.length);
  // ä» å¯è§£æä¾èµ– ä¸­ æŸ¥æ‰¾æ˜¯å¦æœ‰è¯¥ ç±»å‹çš„ ä¾èµ–ï¼Œå¦‚æœæœ‰ä¹Ÿè¢«è€ƒè™‘è¿› result
  for (Map.Entry<Class<?>, Object> classObjectEntry : this.resolvableDependencies.entrySet()) {
    Class<?> autowiringType = classObjectEntry.getKey();
    if (autowiringType.isAssignableFrom(requiredType)) {
      Object autowiringValue = classObjectEntry.getValue();
      autowiringValue = AutowireUtils.resolveAutowiringValue(autowiringValue, requiredType);
      if (requiredType.isInstance(autowiringValue)) {
        result.put(ObjectUtils.identityToString(autowiringValue), autowiringValue);
        break;
      }
    }
  }
  // æ ¹æ®å€™é€‰çš„ Bean åç§°ï¼Œé€šè¿‡å…¶ BeanDefinition åˆ¤æ–­æ˜¯å¦å¯ä»¥åŠ å…¥åˆ° result
  for (String candidate : candidateNames) {
    if (!isSelfReference(beanName, candidate) && isAutowireCandidate(candidate, descriptor)) {
      addCandidateEntry(result, candidate, descriptor, requiredType);
    }
  }
  
  // ç»“æœä¸ºç©º
  if (result.isEmpty()) {
    // åˆ¤æ–­å­—æ®µä¸æ˜¯å¤š Bean çš„åœºæ™¯
    boolean multiple = indicatesMultipleBeans(requiredType);
    // Consider fallback matches if the first pass failed to find anything...
    DependencyDescriptor fallbackDescriptor = descriptor.forFallbackMatch();
    for (String candidate : candidateNames) {
      if (!isSelfReference(beanName, candidate) && isAutowireCandidate(candidate, fallbackDescriptor) &&
          (!multiple || getAutowireCandidateResolver().hasQualifier(descriptor))) {
        addCandidateEntry(result, candidate, descriptor, requiredType);
      }
    }
    // è¿˜ä¸ºç©º å¹¶ä¸” å­—æ®µä¸ä¸ºå¤š Bean çš„åœºæ™¯
    if (result.isEmpty() && !multiple) {
      // Consider self references as a final pass...
      // but in the case of a dependency collection, not the very same bean itself.
      for (String candidate : candidateNames) {
        if (isSelfReference(beanName, candidate) &&
            (!(descriptor instanceof MultiElementDescriptor) || !beanName.equals(candidate)) &&
            isAutowireCandidate(candidate, fallbackDescriptor)) {
          addCandidateEntry(result, candidate, descriptor, requiredType);
        }
      }
    }
  }
  return result;
}
```

æ€»ç»“ä¸€ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š

- å…ˆä» IoC å®¹å™¨ä¸­æŸ¥æ‰¾æŒ‡å®šç±»å‹çš„`å€™é€‰ Bean é›†åˆ`
- å®ä¾‹åŒ–ä¸€ä¸ª Map<String,Object> çš„é›†åˆ`result`ï¼Œç”¨æ¥å­˜å‚¨è¯¥ç±»å‹å¯¹åº”çš„ `å€™é€‰ä¾èµ–`
- ä» `å¯è§£æä¾èµ–` é‡ŒæŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„å€™é€‰å¹¶æ·»åŠ è¿› result ä¸­
- ä» `å€™é€‰ Bean é›†åˆ`ä¸­æ‰¾åˆ° éè‡ªå¼•ç”¨ï¼ˆå€™é€‰Bean æŒ‡å‘ å½“å‰Bean æˆ–è€… å€™é€‰Bean çš„ å·¥å‚Bean æ‰§è¡Œå½“å‰Beanï¼‰ã€å¹¶ä¸”BeanDefinition#autowire-candidateä¸ºtrueçš„å€™é€‰BeanåŠ å…¥åˆ°resultä¸­
- ç»“æœä¸ºç©ºçš„å…œåº•ï¼Œç»ç¬¦åˆä¸€å®šæ¡ä»¶çš„å€™é€‰ Bean åŠ å…¥åˆ° result ä¸­
- å°† result è¿”å›ï¼Œå¾—åˆ°æœ€ç»ˆçš„ä¾èµ–æº

ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼Œä¾èµ–æ³¨å…¥çš„æ¥æºåŒ…æ‹¬ä¸¤æ–¹é¢ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š

- ä¾èµ–æŸ¥æ‰¾çš„æ¥æº
- å¯è§£æä¾èµ– resolvableDependenciesï¼Œæºç ä½äº org.springframework.beans.factory.support.DefaultListableBeanFactory#resolvableDependencies

## æœ¬æ–‡æ€»ç»“

æœ¬ç¯‡ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¾èµ–æ³¨å…¥çš„ä½¿ç”¨æ–¹å¼å’Œå…¶æ³¨å…¥åŸç†ï¼Œå¹¶è¿½æ ¹æº¯æºå®šä½çš„ä¾èµ–çš„æ¥æºï¼Œåˆ†æäº†ä¾èµ–æŸ¥æ‰¾çš„æ¥æºä»¥åŠä¾èµ–æ³¨å…¥çš„æ¥æºã€‚å¤§å®¶å¯ä»¥ç»“åˆæœ¬ç¯‡æ–‡ç« è¿›å…¥åˆ°æºç è¿›è¡Œç ”è¯»ï¼Œå°è±¡ä¼šæ›´æ·±åˆ»ã€‚é’ˆå¯¹ @Autowired æ³¨è§£çš„ä½¿ç”¨å’ŒåŸç†åˆ†ææˆ‘æ”¾åœ¨äº†å¦ä¸€ç¯‡[ä¸€æ–‡ææ‡‚Spring@Autowiredæ³¨è§£çš„ä½¿ç”¨åŠå…¶åŸç†](./ä¸€æ–‡ææ‡‚Spring@Autowiredæ³¨è§£çš„ä½¿ç”¨åŠå…¶åŸç†.md)ï¼Œæœ‰å…´è¶£çš„ä¹Ÿå¯ä»¥å»äº†è§£é˜…è¯»ä¸‹ã€‚

